# bwa-mem-hs38-rlc

This repository contains all the code needed to align a paired-end reads to 
the latest human reference genome.

It will be made available to run on the RLC network.

This is considered experimental and should only be used for data approved for
general research use.

This source code is made available using GPLv3.

## Background of iExec RLC

RLC is a framework for performing tasks that leverages the Ethereum blockchain. It 
uses the RLC token to pay for, and be paid for jobs. Workers make computing resources 
available and can run tasks like the one here.

For more information on iExec see [here](https://iex.ec).

## Background of bwa

Burrows-Wheeler alignment is an industry standard algorithm for aligning paired-end 
sequence data to a reference genome. bwa is a popular implementation in C++ that operates 
on FASTQ files to generate SAM or BAM files. These aligned genome files can be used downstream 
to compare variation between samples or analyzed using other tools.

## Docker image

The docker image has been prepared to include the hs38 reference genome, which is the latest
reference genome made available. For this reason, the Docker image may take a while to download.

bwa is built on the Docker image itself. Once this is done and the reference genome has been 
downloaded we generate a bwa index. Again, this has been done ahead of time and means that 
the docker image should not have to contact the internet to download any other data during 
operation.

bwa can be fairly resource intensive so it is suggested to have at least 16GB of available memory.

## Input data with RLC

RLC uses a set of environment variables to make computation predictable within the Docker 
image.  In this section we'll walk through what input data you would provide using an example
from 1000 Genomes.

Performing an alignment to a reference genome requires you provide two FASTQ files. These files 
are often labeled `_1` and `_2` respectively to denote which end of the paired read they represent. 

IEXEC_INPUT_FILES_FOLDER = '/iexec_in/' # This is the directory in the docker image where the input files are stored
IEXEC_NB_INPUT_FILES = 2 # We need to provide 2 input files for the paired reads
IEXEC_INPUT_FILE_NAME_1 # First file of the pair
IEXEC_INPUT_FILE_NAME_2 # Second file of the pair

## Proof of contribution

RLC requires that to prove some computation occurred that for some given input a deterministic output 
is generated. 

TODO we should use the hash of the output files, can we guarantee we will always get the same result?

## Arguments

Passing the arguments line directly to bwamem, make a string like `-x ont2d -Hs -o myname`

```
Usage:   run-bwamem [options] <idxbase> <file1> [file2]
Options: -o STR    prefix for output files                       [inferred from input]
         -R STR    read group header line such as \'@RG\tID:foo\tSM:bar\'         [null]
         -x STR    read type: pacbio, ont2d or intractg                      [default]
                   intractg: intra-species contig (kb query, highly similar)
                   pacbio:   pacbio subreads (~10kb query, high error rate)
                   ont2d:    Oxford Nanopore reads (~10kb query, higher error rate)
         -t INT    number of threads                                               [1]
         -H        apply HLA typing
         -a        trim HiSeq2000/2500 PE resequencing adapters (via trimadap)
         -d        mark duplicate (via samblaster)
         -S        for BAM input, don\'t shuffle
         -s        sort the output alignment (via samtools; requring more RAM)
         -k        keep temporary files generated by typeHLA
         -M        mark shorter split hits as secondary
```

To read more about the bwakit flags see here https://github.com/lh3/bwa/blob/master/bwakit/run-bwamem

## Testing locally

If you're reading this you'd probably like to run this locally before exporting the task
to the RLC network. To do so you need to run the docker image while explicitly setting the arguments 
that would otherwise be provided via RLC.

A script demonstrating running this locally is in `test.sh`. It will download data from 1kgenomes as
an example.

TODO make a smaller FASTQ for testing

## Uploading to RLC

Upload image to docker

set up RLC account/wallet

Make an iexec.json with details of the application https://docs.iex.ec/for-developers/your-first-app

## Run on iExec

Run and download results

## Publish on iExec marketplace

## Future work

* Demonstrate enclave
* Encrypted inputs
* encrypted outputs
